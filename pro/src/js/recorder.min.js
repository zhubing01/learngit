!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("babel-runtime/core-js/promise"),require("babel-runtime/core-js/object/assign")):"function"==typeof define&&define.amd?define(["babel-runtime/core-js/promise","babel-runtime/core-js/object/assign"],t):e.Recorder=t(e._Promise,e._Object$assign)}(this,function(e,t){"use strict";function r(e){(console.warn||console.log)("[Recorder warn]: "+e)}function n(e,t){return function(r){var n=this;if(!t)return new d(e);if(d&&!r){var o=i(`${t}`.replace(/^function.+?{/,"").slice(0,-1));return this[u]=new d(o),h.revokeObjectURL(o),this[u]}var a={postMessage:e=>{n.onmessage&&setTimeout(()=>n.onmessage({data:e,target:a}))}};t.call(a),this.postMessage=(e=>{setTimeout(()=>a.onmessage({data:e,target:n}))}),this.isThisThread=!0}}function i(e){try{return h.createObjectURL(new Blob([e],{type:c}))}catch(r){var t=new f;return t.append(e),h.createObjectURL(t.getBlob(type))}}function o(e){this._init(e)}e=e&&"default"in e?e.default:e,t=t&&"default"in t?t.default:t;var a={isPreAuth:!1,isExportURL:!1,useVAD:!0,useVVD:!0},s={bufferSize:4096,numChannels:1},u="undefined"==typeof Symbol?"__target":Symbol(),c="application/javascript",f=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,h=window.URL||window.webkitURL,d=window.Worker;if(d){var p,l=i("self.onmessage = function () {}"),g=new Uint8Array(1);try{if(/(?:Trident|Edge)\/(?:[567]|12)/i.test(navigator.userAgent))throw new Error("Not available");(p=new d(l)).postMessage(g,[g.buffer])}catch(e){d=null}finally{h.revokeObjectURL(l),p&&p.terminate()}}var m=new n("./recorder.worker.js",function(e,t){function r(e){l=e.sampleRate||l,g=e.outputBufferLength||g,d=e.numChannels||d,m=e.useVAD||m,v=e.useVVD||v,n()}function n(){recBuffers=[],recBuffersLength=0,vRecBuffers=[]}function i(e){if(recBuffers.push(e),recBuffersLength+=e.length,m||v){var t=new h(l,16e3,1,g,!0),r=void 0,n=[];for(r=0;r<e.length;r++)n.push(e[r]);var i=t.resampler(n),o=new Float32Array(i);for(r=0;r<i;r++)o[r]=t.outputBuffer[r];var a=s(o);for(r=0;r<a.length;r++)vRecBuffers.push(a[r]);for(;vRecBuffers.length>320;){var u=vRecBuffers.splice(0,320),c=new Int16Array(u),f=w(c);this.postMessage({command:"detection",data:{volume:f,buffer:c}})}}}function o(){if(0===recBuffersLength||0===recBuffers.length)return void this.postMessage({command:"exportWAV",data:null});var e=f(a(recBuffers,recBuffersLength)),t=new Blob([e],{type:p});this.postMessage({command:"exportWAV",data:t})}function a(e,t){for(var r=new Float32Array(t),n=0,i=0;i<e.length;i++)r.set(e[i],n),n+=e[i].length;return r}function s(e){for(var t=new Int16Array(e.length),r=0;r<e.length;r++){var n=Math.max(-1,Math.min(1,e[r]));t[r]=n<0?32768*n:32767*n}return t}function u(e,t,r){for(var n=0;n<r.length;n++,t+=2){var i=Math.max(-1,Math.min(1,r[n]));e.setInt16(t,i<0?32768*i:32767*i,!0)}}function c(e,t,r){for(var n=0;n<r.length;n++)e.setUint8(t+n,r.charCodeAt(n))}function f(e){var t=new ArrayBuffer(44+2*e.length),r=new DataView(t);return c(r,0,"RIFF"),r.setUint32(4,36+2*e.length,!0),c(r,8,"WAVE"),c(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,d,!0),r.setUint32(24,l,!0),r.setUint32(28,4*l,!0),r.setUint16(32,2*d,!0),r.setUint16(34,16,!0),c(r,36,"data"),r.setUint32(40,2*e.length,!0),u(r,44,e),r}function h(e,t,r,n,i){this.fromSampleRate=e,this.toSampleRate=t,this.channels=0|r,this.outputBufferSize=n,this.noReturn=!!i,this.initialize()}var d=1,p="audio/wav",l=44100,g=4096,m=!1,v=!1;onmessage=function(e){switch(e.data.command){case"init":r(e.data.config||{});break;case"sendBuffer":i(e.data.buffer);break;case"exportWAV":o();break;case"clear":n()}};var w=function(e){var t=[329,421,543,694,895,1146,1476,1890,2433,3118,4011,5142,6612,8478,10900,13982,17968,23054,29620,38014,48828,62654,80491,103294,132686,170366,218728,280830];return function(e){var r=30;return t.every(function(t,n){return!(e<t)||(r=n,!1)}),r}(function(e){if(null==e||e.byteLength<=2)return 0;var t,r=0;for(t=0;t<e.length;t++)r+=e[t];r/=e.length;var n=0;for(t=0;t<e.length;t++)n+=parseInt(Math.pow(e[t]-r,2))>>9;return n/=e.length,parseInt(n)}(e))};h.prototype.initialize=function(){if(!(this.fromSampleRate>0&&this.toSampleRate>0&&this.channels>0))throw new Error("Invalid settings specified for the resampler.");this.fromSampleRate==this.toSampleRate?(this.resampler=this.bypassResampler,this.ratioWeight=1):(this.fromSampleRate<this.toSampleRate?(this.lastWeight=1,this.resampler=this.compileLinearInterpolation):(this.tailExists=!1,this.lastWeight=0,this.resampler=this.compileMultiTap),this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.initializeBuffers())},h.prototype.compileLinearInterpolation=function(e){var t=e.length,r=this.outputBufferSize;if(t%this.channels==0){if(t>0){for(var n,i=this.ratioWeight,o=this.lastWeight,a=0,s=0,u=0,c=this.outputBuffer;o<1;o+=i)for(a=1-(s=o%1),n=0;n<this.channels;++n)c[u++]=this.lastOutput[n]*a+e[n]*s;for(o--,t-=this.channels,sourceOffset=Math.floor(o)*this.channels;u<r&&sourceOffset<t;){for(a=1-(s=o%1),n=0;n<this.channels;++n)c[u++]=e[sourceOffset+n]*a+e[sourceOffset+this.channels+n]*s;o+=i,sourceOffset=Math.floor(o)*this.channels}for(n=0;n<this.channels;++n)this.lastOutput[n]=e[sourceOffset++];return this.lastWeight=o%1,this.bufferSlice(u)}return this.noReturn?0:[]}throw new Error("Buffer was of incorrect sample length.")},h.prototype.compileMultiTap=function(e){var t=[],r=e.length,n=this.outputBufferSize;if(r%this.channels==0){if(r>0){for(var i=this.ratioWeight,o=0,a=0;a<this.channels;++a)t[a]=0;var s=0,u=0,c=!this.tailExists;this.tailExists=!1;var f=this.outputBuffer,h=0,d=0;do{if(c)for(o=i,a=0;a<this.channels;++a)t[a]=0;else{for(o=this.lastWeight,a=0;a<this.channels;++a)t[a]+=this.lastOutput[a];c=!0}for(;o>0&&s<r;){if(u=1+s-d,!(o>=u)){for(a=0;a<this.channels;++a)t[a]+=e[s+a]*o;d+=o,o=0;break}for(a=0;a<this.channels;++a)t[a]+=e[s++]*u;d=s,o-=u}if(0!=o){for(this.lastWeight=o,a=0;a<this.channels;++a)this.lastOutput[a]=t[a];this.tailExists=!0;break}for(a=0;a<this.channels;++a)f[h++]=t[a]/i}while(s<r&&h<n);return this.bufferSlice(h)}return this.noReturn?0:[]}throw new Error("Buffer was of incorrect sample length.")},h.prototype.bypassResampler=function(e){return this.noReturn?(this.outputBuffer=e,e.length):e},h.prototype.bufferSlice=function(e){if(this.noReturn)return e;try{return this.outputBuffer.subarray(0,e)}catch(t){try{return this.outputBuffer.length=e,this.outputBuffer}catch(t){return this.outputBuffer.slice(0,e)}}},h.prototype.initializeBuffers=function(){try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(e){this.outputBuffer=[],this.lastOutput=[]}}}),v=new n("./vad.worker.js",function(e,t){function r(e){postMessage({type:"debug",message:e})}function n(){r("vad init"),w=new Array,b=new Array,y=new Array,E=new Array,i()}function i(){I=0,S=0,D=0,p=0,d=C.ESVAD_SILENCE,B=parseInt($),M=0,A=0,_=0}function o(e,t,r,n,i){for(var o=0;o<i;)E[n+o]=e[t+o],o++}function a(e,t){var n,i;if(r("call AppendData function, pcmDataLength : "+t+", pcmData[0] : "+e[0]),1==t){var a=A;return w[a]=e[0],++a>=W&&(a-=W),a==_?7:(A=a,0)}if((n=parseInt(A-_))<0&&(n+=W),(n+=t)>W-1)return 7;if(A+t<W){for(i=0;i<t;i++)w[A+i]=e[i];A+=t}else{var f=W-A;for(f=W-A,i=0;i<f;i++)w[A+i]=e[i];for(i=0;i<t-f;i++)w[i]=e[f+i];A=t-f}for(r("call AppendData function, m_iPCMEnd : "+A);;){var p=!1;if(C.ESVAD_INACTIVE!=d&&(p=c())){if(y[I%T]=u(),o(b,0,E,I%parseInt(T)*parseInt(U)*2,2*parseInt(U)),++I<parseInt(L))continue;h()}if(B<M){if(Y){l=new Array;o(E,B%parseInt(T)*parseInt(U)*2,l,0,parseInt(2*U)),Z[Z.length]=l}B++}if(C.ESVAD_INACTIVE==d&&B<M){if(Y){var l=new Array;o(E,B%parseInt(T)*parseInt(U)*2,l,0,parseInt(2*U)),Z[Z.length]=l}B++}if(!p)break}v=0;var g=0;for(i=0;i<t;i++){var m;g+=(m=e[i]>>2)*m+8>>4}return g/=t,g<256?v=0:(v=s(g,6)>>22)>9&&(v=9),r("vad volume : "+v),postMessage({command:"volume",message:v}),0}function s(e,t){var r,n,i=t;return 0==(4294901760&++e)&&(e<<=16,i+=16),0==(4278190080&e)&&(e<<=8,i+=8),0==(4026531840&e)&&(e<<=4,i+=4),0==(3221225472&e)&&(e<<=2,i+=2),0==(2147483648&e)&&(e<<=1,i+=1),e-=2147483648,n=e>>21,r=X[n]<<7,r+=(31-i)*parseInt(J)}function u(){var e,t,r=0;for(e=0;e<R;e++)r+=b[e];for(r/=parseInt(R),t=0,e=0;e<R;e++){var n;t+=(n=b[e]-r)*n+128>>8}return t>>=2,Math.max(40,t)}function c(){var e=parseInt(A-_);if(e<0&&(e+=parseInt(W)),e<R)return!1;if(_+R<=W){for(t=0;t<R;t++)b[t]=w[_+t];_+=U}else{var t,r=W-_;for(t=0;t<r;t++)b[t]=w[_+t];for(t=0;t<R-r;t++)b[r+t]=w[t];(_+=U)>W&&(_-=W)}return!0}function f(e,t,r){for(var n=0,i=0;n<r;n++)if(y[(V+n)%T]>e?i++:i=0,i>t)return V=n+V-t,!0;return!1}function h(){var e,t,n,i,o;for(e=I-S;0!=e;){if(0==(e=I-S))return;if(0==p){if(e<L)return;if(S<=R/U){++S;continue}for(x=parseInt(O),p=0,t=0;t<L;t++)p+=y[(S+t)%T];p/=parseInt(L),V=S+1,i=p+200,l=parseInt(20*i/((s(i,0)+Q>>18)-64)),l<<=5,l-=200}switch(r("check vad state : "+d),d){case C.ESVAD_SILENCE:if(parseInt(I-V)<N)return;if(f(l,parseInt(K),parseInt(N))){for(t=S+1;t<=V-L;++t){for(i=0,n=0;n<L;n++)i+=y[(t+n)%T];(i/=parseInt(L))<p&&(p=i,S=t)}o=((i=parseInt(s(p,0)+Q>>14))-2304)*(i-2304)>>12,g=360*p/(o+=512)<<5,D=V,d=C.ESVAD_CHECK_BEGIN,ee=!0}else p=0,d=C.ESVAD_SILENCE,S++;break;case C.ESVAD_CHECK_BEGIN:if(parseInt(I-V)<j)return;if(f(g,parseInt(P),parseInt(j))){V=(S=D)+1,B=Math.max(D-parseInt(G),parseInt($)),d=C.ESVAD_ACTIVE,M=Math.min(D+parseInt(H),I),k=D,Math.max(D,parseInt($)),m=0}else p=0,d=C.ESVAD_SILENCE,S++;break;case C.ESVAD_ACTIVE:(i=y[S%T])<l?(d=C.ESVAD_CHECK_END,V=S+1):((m=Math.max(m,i))>g*q&&(i=s(m/q,-10)>>14,i=(i-=2304)*i>>12,i+=512,i=s(i=m/(16*parseInt(q))*i/720,-10)>>14,i=(i-=2304)*i>>12,i+=512,i=m/(16*parseInt(q))*i/720,l=20*(i=(p=i)+200)/parseInt((s(i,0)+Q>>18)-64),l<<=5,l-=200,o=((i=parseInt(s(p,0)+Q>>14))-2304)*(i-2304)>>12,g=360*p/(o+=512)<<5),S++),M=Math.min(S+parseInt(H),I),k=S;break;case C.ESVAD_CHECK_END:if(M=Math.min(S+parseInt(H),I),k=S,I-V<x)return;if(!f(g,parseInt(F),x))return d=C.ESVAD_INACTIVE,te=!0,r("local vad check end!!!!"),postMessage({command:"esvad",message:"end"}),V=S+1,p=0,void(M-D<z+H&&(D=0,M=0,d=C.ESVAD_SILENCE));r("local vad check end!!!!"+f(g,parseInt(F),x)),S++,d=C.ESVAD_ACTIVE,x=parseInt(O);break;case C.ESVAD_INACTIVE:return}}}onmessage=function(e){switch(r(e.data),e.data.command){case"init":n();break;case"appendData":a(e.data.pcmData,e.data.nSamples)}};var d,p,l,g,m,v,w,_,A,b,E,I,y,S,V,D,M,k,B,x,C={ESVAD_SILENCE:0,ESVAD_CHECK_BEGIN:1,ESVAD_ACTIVE:2,ESVAD_CHECK_END:3,ESVAD_INACTIVE:4},W=163840,R=200,U=80,L=3,N=20,j=20,O=200,T=129,z=18,K=5,P=4,F=3,G=25,H=40,q=256,$=8,J=2907270,Q=29072700,X=[0,32,64,96,128,160,191,223,255,287,318,350,382,413,445,477,508,540,571,602,634,665,697,728,759,790,822,853,884,915,946,977,1008,1039,1070,1101,1132,1163,1194,1225,1256,1286,1317,1348,1379,1409,1440,1471,1501,1532,1562,1593,1623,1654,1684,1714,1745,1775,1805,1836,1866,1896,1926,1956,1987,2017,2047,2077,2107,2137,2167,2197,2227,2256,2286,2316,2346,2376,2406,2435,2465,2495,2524,2554,2583,2613,2643,2672,2702,2731,2760,2790,2819,2849,2878,2907,2936,2966,2995,3024,3053,3082,3111,3141,3170,3199,3228,3257,3286,3315,3343,3372,3401,3430,3459,3488,3516,3545,3574,3603,3631,3660,3688,3717,3746,3774,3803,3831,3860,3888,3916,3945,3973,4001,4030,4058,4086,4115,4143,4171,4199,4227,4255,4283,4311,4340,4368,4396,4424,4451,4479,4507,4535,4563,4591,4619,4646,4674,4702,4730,4757,4785,4813,4840,4868,4895,4923,4950,4978,5005,5033,5060,5088,5115,5143,5170,5197,5224,5252,5279,5306,5333,5361,5388,5415,5442,5469,5496,5523,5550,5577,5604,5631,5658,5685,5712,5739,5766,5792,5819,5846,5873,5900,5926,5953,5980,6006,6033,6060,6086,6113,6139,6166,6192,6219,6245,6272,6298,6324,6351,6377,6403,6430,6456,6482,6509,6535,6561,6587,6613,6640,6666,6692,6718,6744,6770,6796,6822,6848,6874,6900,6926,6952,6977,7003,7029,7055,7081,7107,7132,7158,7184,7209,7235,7261,7286,7312,7338,7363,7389,7414,7440,7465,7491,7516,7542,7567,7592,7618,7643,7668,7694,7719,7744,7770,7795,7820,7845,7870,7896,7921,7946,7971,7996,8021,8046,8071,8096,8121,8146,8171,8196,8221,8246,8271,8295,8320,8345,8370,8395,8419,8444,8469,8494,8518,8543,8568,8592,8617,8641,8666,8691,8715,8740,8764,8789,8813,8837,8862,8886,8911,8935,8959,8984,9008,9032,9057,9081,9105,9129,9154,9178,9202,9226,9250,9274,9299,9323,9347,9371,9395,9419,9443,9467,9491,9515,9539,9562,9586,9610,9634,9658,9682,9706,9729,9753,9777,9801,9824,9848,9872,9895,9919,9943,9966,9990,10013,10037,10061,10084,10108,10131,10155,10178,10202,10225,10248,10272,10295,10319,10342,10365,10389,10412,10435,10458,10482,10505,10528,10551,10574,10598,10621,10644,10667,10690,10713,10736,10759,10782,10805,10828,10851,10874,10897,10920,10943,10966,10989,11012,11035,11058,11080,11103,11126,11149,11171,11194,11217,11240,11262,11285,11308,11330,11353,11376,11398,11421,11443,11466,11489,11511,11534,11556,11579,11601,11623,11646,11668,11691,11713,11735,11758,11780,11803,11825,11847,11869,11892,11914,11936,11958,11981,12003,12025,12047,12069,12091,12114,12136,12158,12180,12202,12224,12246,12268,12290,12312,12334,12356,12378,12400,12422,12444,12465,12487,12509,12531,12553,12575,12596,12618,12640,12662,12683,12705,12727,12749,12770,12792,12814,12835,12857,12878,12900,12922,12943,12965,12986,13008,13029,13051,13072,13094,13115,13137,13158,13179,13201,13222,13244,13265,13286,13308,13329,13350,13372,13393,13414,13435,13457,13478,13499,13520,13541,13562,13584,13605,13626,13647,13668,13689,13710,13731,13752,13773,13794,13815,13836,13857,13878,13899,13920,13941,13962,13983,14004,14025,14045,14066,14087,14108,14129,14149,14170,14191,14212,14232,14253,14274,14295,14315,14336,14357,14377,14398,14418,14439,14460,14480,14501,14521,14542,14562,14583,14603,14624,14644,14665,14685,14706,14726,14747,14767,14787,14808,14828,14848,14869,14889,14909,14930,14950,14970,14991,15011,15031,15051,15071,15092,15112,15132,15152,15172,15192,15213,15233,15253,15273,15293,15313,15333,15353,15373,15393,15413,15433,15453,15473,15493,15513,15533,15553,15573,15593,15612,15632,15652,15672,15692,15712,15731,15751,15771,15791,15811,15830,15850,15870,15889,15909,15929,15948,15968,15988,16007,16027,16047,16066,16086,16105,16125,16145,16164,16184,16203,16223,16242,16262,16281,16301,16320,16340,16359,16378,16398,16417,16437,16456,16475,16495,16514,16533,16553,16572,16591,16610,16630,16649,16668,16687,16707,16726,16745,16764,16784,16803,16822,16841,16860,16879,16898,16917,16937,16956,16975,16994,17013,17032,17051,17070,17089,17108,17127,17146,17165,17184,17203,17222,17240,17259,17278,17297,17316,17335,17354,17373,17391,17410,17429,17448,17467,17485,17504,17523,17542,17560,17579,17598,17616,17635,17654,17673,17691,17710,17728,17747,17766,17784,17803,17821,17840,17859,17877,17896,17914,17933,17951,17970,17988,18007,18025,18044,18062,18080,18099,18117,18136,18154,18173,18191,18209,18228,18246,18264,18283,18301,18319,18337,18356,18374,18392,18411,18429,18447,18465,18483,18502,18520,18538,18556,18574,18592,18611,18629,18647,18665,18683,18701,18719,18737,18755,18773,18791,18810,18828,18846,18864,18882,18900,18917,18935,18953,18971,18989,19007,19025,19043,19061,19079,19097,19114,19132,19150,19168,19186,19204,19221,19239,19257,19275,19293,19310,19328,19346,19364,19381,19399,19417,19434,19452,19470,19487,19505,19523,19540,19558,19576,19593,19611,19628,19646,19663,19681,19699,19716,19734,19751,19769,19786,19804,19821,19839,19856,19873,19891,19908,19926,19943,19961,19978,19995,20013,20030,20048,20065,20082,20100,20117,20134,20151,20169,20186,20203,20221,20238,20255,20272,20290,20307,20324,20341,20358,20376,20393,20410,20427,20444,20461,20479,20496,20513,20530,20547,20564,20581,20598,20615,20632,20649,20666,20683,20700,20717,20734,20751,20768,20785,20802,20819,20836,20853,20870,20887,20904,20921,20938,20955,20972,20988,21005,21022,21039,21056,21073,21089,21106,21123,21140,21157,21173,21190,21207,21224,21240,21257,21274,21291,21307,21324,21341,21357,21374,21391,21407,21424,21441,21457,21474,21491,21507,21524,21540,21557,21573,21590,21607,21623,21640,21656,21673,21689,21706,21722,21739,21755,21772,21788,21805,21821,21837,21854,21870,21887,21903,21920,21936,21952,21969,21985,22001,22018,22034,22050,22067,22083,22099,22116,22132,22148,22164,22181,22197,22213,22229,22246,22262,22278,22294,22311,22327,22343,22359,22375,22391,22408,22424,22440,22456,22472,22488,22504,22520,22537,22553,22569,22585,22601,22617,22633,22649,22665,22681,22697],Y=!0,Z=new Array,ee=!1,te=!1});return function(n){n.prototype={_init:function(e){if(this._events={},this._callbacks={exportWAV:[]},this._audio={recording:!1,context:null,stream:null,node:{source:null,scriptNode:null}},this.options=t({},a,e),this._compatibility(),!this._checkSupport())return this.trigger("checkSupportError"),void r("No web audio support in this browser!");this.options.isPreAuth&&this.preAuth("init"),this._recorderWorker(),this._vadWorker()},_recorderWorker:function(){var e=this;this.recorderWorker.onmessage=function(t){switch(t.data.command){case"exportWAV":e._exportWAV(t.data.data);break;case"detection":e._detection(t.data.data)}}},_vadWorker:function(){var e=this;this.vadWorker.onmessage=function(t){"esvad"===t.data.command&&"end"===t.data.message&&e._vadEnd()}},_compatibility:function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,window.URL=window.URL||window.webkitURL;var t=function(t,r,n){return navigator.getUserMedia?new e(function(e,r){navigator.getUserMedia.call(navigator,t,e,r)}):e.reject(new Error("getUserMedia is not implemented in this browser"))};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=t)},_checkSupport:function(){var e=!0,t=["AudioContext","URL","Worker"];if(!navigator.mediaDevices.getUserMedia)return!1;for(var r=0,n=t.length;r<n;r++)if(!window[t[r]]){e=!1;break}return e},preAuth:function(){var e=this;if("init"!==arguments[0]&&this.options.isPreAuth)return void r("已经做过预授权");navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){for(var r=t.getAudioTracks(),n=0,i=r.length;n<i;n++)r[n].stop();t=null,e.trigger("preAuth")},function(t){e.trigger("preAuthError",t.name?t.name:t),r(t.name?t.name:t)})},_initMedia:function(){var e=this,t=this._audio.context.sampleRate;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(r){e._audio.stream=r,e._audio.node.source=e._audio.context.createMediaStreamSource(r),e._audio.node.scriptNode=e._audio.context.createScriptProcessor(s.bufferSize,1,1),e._audio.node.scriptNode.onaudioprocess=function(t){if(e._audio.recording){var r=t.inputBuffer.getChannelData(0);e.recorderWorker.postMessage({command:"sendBuffer",buffer:r}),e.trigger("audioProcess",t)}},e._audio.node.source.connect(e._audio.node.scriptNode),e._audio.node.scriptNode.connect(e._audio.context.destination),e.recorderWorker.postMessage({command:"init",config:{sampleRate:t,outputBufferLength:s.bufferSize,numChannels:s.numChannels,useVAD:e.options.useVAD,useVVD:e.options.useVVD}}),e._audio.recording=!0,e.trigger("start")},function(t){e.trigger("startError",t.name?t.name:t),r(t.name?t.name:t)})},start:function(){return this.options.useVAD&&this.vadWorker.postMessage({command:"init"}),this._audio.context||(this._audio.context=new window.AudioContext),"function"==typeof this._audio.context.resume&&this._audio.context.resume(),this._audio.stream?(this.recorderWorker.postMessage({command:"init"}),this._audio.recording=!0,this.trigger("start"),this):void this._initMedia()},destroy:function(){if(this._audio.recording=!1,null!=this._audio.stream){for(var e=this._audio.stream.getAudioTracks(),t=0;t<e.length;t++)e[t].stop();this._audio.stream=null}null!=this._audio.node.source&&(this._audio.node.source.disconnect(),this._audio.node.scriptNode.disconnect(),this._audio.node.source=null,this._audio.node.scriptNode=null),this.recorderWorker.postMessage({command:"clear"}),this.trigger("destroy")},stop:function(){this._audio.recording=!1,this.recorderWorker.postMessage({command:"clear"}),this.trigger("stop")},exportWAV:function(e){this._audio.recording=!1,"function"==typeof e&&this._callbacks.exportWAV.push(e),this.recorderWorker.postMessage({command:"exportWAV"})},_exportWAV:function(e){if(!e)return void r("貌似还没有开始录音，请重试。");var t=this._callbacks.exportWAV.pop(),n=this.options.isExportURL?URL.createObjectURL(e):void 0;"function"==typeof t&&t(e,n),this.trigger("exportWAV",e,n)},_detection:function(e){this.options.useVVD&&this.trigger("volumeChange",e.volume||null),this.options.useVAD&&this.vadWorker.postMessage({command:"appendData",pcmData:e.buffer,nSamples:e.buffer.length})},_vadEnd:function(){this._audio.recording=!1,this.trigger("vadEnd")}}}(o),function(e){e.prototype.on=function(e,t){void 0===this._events[e]&&(this._events[e]=[]),this._events[e].push(t)},e.prototype.off=function(e,t){var r=this._events[e];if(void 0!==r&&"[object Array]"===Object.prototype.toString.call(r))for(var n=0,i=r.length;n<i;n++)t===r[n]&&r.splice(n,1)},e.prototype.trigger=function(e){var t=this._events[e];if(void 0!==t&&"[object Array]"===Object.prototype.toString.call(t))for(var r=0,n=t.length;r<n;r++)t[r].apply(null,[].slice.call(arguments,1))}}(o),function(e){e.prototype.recorderWorker=new m}(o),function(e){e.prototype.vadWorker=new v}(o),o});
